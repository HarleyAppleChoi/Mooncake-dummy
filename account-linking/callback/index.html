<!DOCTYPE html>
<html lang="en">
  <head>
    <title>My Recipe App</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/gh/IdentityModel/oidc-client-js@1.10.1/dist/oidc-client.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/auth0/jwt-decode@2.2.0/build/jwt-decode.js"></script>
    <link rel="stylesheet" type="text/css" href="../style.css" />
    <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
  </head>
  <body>
    <div class="main">
      <div id="response">
        <div id="myData"></div>
        <h2>Welcome to All My Chard</h2>
        <!-- like button to see which post (0-11) to like -->
        <h2>Like which post?</h2>
        <form>
          <label for="fname">Post number:</label><br>
          <input type="text" id="like-post-name" name="like-post-name" id="like_post_id"><br>
          <input type="button" value="Like!" id="like-button">
        </form>
        <!-- Comment on which post? -->
        <h2>Comment which post?</h2>
        <form>
          <label for="fname">Post number:</label><br>
          <input type="text" id="comment-post-name" name="comment-post-name" data-cy="comment-post-id"><br>
          <label for="fname">Comment:</label><br>
          <input type="text" id="comment-post-text" name="comment-post-text" data-cy="comment-post-text"><br>
          <input type="button" value="Comment!" id="comment-button">
        </form>
        <!-- #region snippet-show -->
        <span>Your user id is</span>
        <button id="user-id" data-cy="user-id"></button>
        <!-- #endregion snippet-show -->
        <button id="grant-access-oasis" data-cy="grant-access-oasis">
          I want to share my recipes!
        </button>
      </div>
    </div>
    <div class="footer">
      <p class="credit">Photo by Brooke Lark on Unsplash</p>
    </div>
    <!-- #region snippet-receive -->
    <script src="callback/appoloconfig.js" type="text/javascript"></script>
    <script src="config.js" type="text/javascript"></script>
    <script>

    document.getElementById("comment-button").onclick = function() {(comment_click())};
    document.getElementById("comment-button").onclick = function() {(like_click())};

    function like_click() {
        document.getElementById(like_post_id).innerText
        console.log()
    }

    function comment_click(){
        upload()
        
    }

    function upload(){
        var userID = document.getElementById('user-id').innerText

    }

    </script>
    <script>

var myList = document.querySelector('ul');

const query = `{
  posts: post(where: {parent_id: {_is_null: true}, subspace: {_eq: "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"}}, order_by: {created: desc}, offset: 1, limit: 11) {
    id
    parent_id
    subspace
    created
    hidden
    last_edited
    allows_comments
    message
    optional_data
    media: medias {
      uri
      mime_type
    }
    poll {
      question
      end_date
      allows_answer_edits
      allows_multiple_answers
      available_answers {
        id: answer_id
        text: answer_text
      }
      user_answers {
        answer
        user {
          address
          dtag
          moniker
          cover_pic
          profile_pic
          bio
        }
      }
    }
    reactions {
      user: owner {
        address
        dtag
        moniker
        cover_pic
        profile_pic
        bio
      }
      value
    }
    user: creator {
      address
      dtag
      moniker
      cover_pic
      profile_pic
      bio
    }
    comments: comments {
      id
    }
  }
}
`

  //getPostDetails
  fetch('https://gql.morpheus.desmos.network/v1/graphql', { 
    method: 'POST',   
    headers: { 'Content-Type': 'application/json' },   
    body: JSON.stringify({ 
      query: query}), 
    })   .then(res => res.json())
    .then(json => console.log(json))
    .then(data => 
      
      {
        var listItem = document.getElementById('myData');
        for(var i = 0;i< data.posts.length;i++) {
        listItem.innerHTML = 'posts:'+ data.post[i].message ;
        listItem.innerHTML +=' created in: ' + data.post[i].created + '.';
        listItem.innerHTML +=' Post by :' + data.post[i].address;
        myList.appendChild(listItem);
      }})
    .catch(err => console.log(err.message, 'error'))
    ;
    </script>

    <script>
      Oidc.Log.logger = console;
      Oidc.Log.level = Oidc.Log.DEBUG;
      const oidcClient = new Oidc.OidcClient(config);
      (async function() {
        try {
          const response = await oidcClient.processSigninResponse(location.href);
          const IDToken = response.id_token;
          const decoded = jwt_decode(IDToken);
          const address = decoded.sub;
          console.log(`ID token:\n${JSON.stringify(decoded, null, '')}`);
          document.getElementById('user-id').innerText = `${address}`;
          document.getElementById('grant-access-oasis').addEventListener('click', function () {
            location.assign(grantUrl(address));
          });
        } catch (error) {
          document.getElementById('user-id').hidden = true;
          document.getElementById('grant-access-oasis').hidden = true;
          document.getElementById('response').innerText = `${error}`;
        }
      })();

    </script>
    <!-- #endregion snippet-receive -->
  </body>
</html>
